<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="core routines">

<title>core – aeiou</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="core – aeiou">
<meta property="og:description" content="core routines">
<meta property="og:site_name" content="aeiou">
<meta name="twitter:title" content="core – aeiou">
<meta name="twitter:description" content="core routines">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">aeiou</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./core.html">core</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aeiou</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">core</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">datasets</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">viz</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chunkadelic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">chunkadelic</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spectrofu.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">spectrofu</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hpc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">hpc</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#get_device" id="toc-get_device" class="nav-link active" data-scroll-target="#get_device">get_device</a></li>
  <li><a href="#is_tool" id="toc-is_tool" class="nav-link" data-scroll-target="#is_tool">is_tool</a></li>
  <li><a href="#normalize_audio" id="toc-normalize_audio" class="nav-link" data-scroll-target="#normalize_audio">normalize_audio</a></li>
  <li><a href="#load_audio" id="toc-load_audio" class="nav-link" data-scroll-target="#load_audio">load_audio</a>
  <ul class="collapse">
  <li><a href="#load_audio-1" id="toc-load_audio-1" class="nav-link" data-scroll-target="#load_audio-1">load_audio</a></li>
  </ul></li>
  <li><a href="#get_dbmax" id="toc-get_dbmax" class="nav-link" data-scroll-target="#get_dbmax">get_dbmax</a>
  <ul class="collapse">
  <li><a href="#get_dbmax-1" id="toc-get_dbmax-1" class="nav-link" data-scroll-target="#get_dbmax-1">get_dbmax</a></li>
  </ul></li>
  <li><a href="#is_silence" id="toc-is_silence" class="nav-link" data-scroll-target="#is_silence">is_silence</a>
  <ul class="collapse">
  <li><a href="#audio_float_to_int" id="toc-audio_float_to_int" class="nav-link" data-scroll-target="#audio_float_to_int">audio_float_to_int</a></li>
  <li><a href="#is_silence-1" id="toc-is_silence-1" class="nav-link" data-scroll-target="#is_silence-1">is_silence</a></li>
  </ul></li>
  <li><a href="#batch_it_crazy" id="toc-batch_it_crazy" class="nav-link" data-scroll-target="#batch_it_crazy">batch_it_crazy</a>
  <ul class="collapse">
  <li><a href="#batch_it_crazy-1" id="toc-batch_it_crazy-1" class="nav-link" data-scroll-target="#batch_it_crazy-1">batch_it_crazy</a></li>
  </ul></li>
  <li><a href="#makedir" id="toc-makedir" class="nav-link" data-scroll-target="#makedir">makedir</a>
  <ul class="collapse">
  <li><a href="#makedir-1" id="toc-makedir-1" class="nav-link" data-scroll-target="#makedir-1">makedir</a></li>
  </ul></li>
  <li><a href="#get_audio_filenames" id="toc-get_audio_filenames" class="nav-link" data-scroll-target="#get_audio_filenames">get_audio_filenames</a>
  <ul class="collapse">
  <li><a href="#fast_scandir" id="toc-fast_scandir" class="nav-link" data-scroll-target="#fast_scandir">fast_scandir</a></li>
  <li><a href="#get_audio_filenames-1" id="toc-get_audio_filenames-1" class="nav-link" data-scroll-target="#get_audio_filenames-1">get_audio_filenames</a></li>
  <li><a href="#untuple" id="toc-untuple" class="nav-link" data-scroll-target="#untuple">untuple</a></li>
  </ul></li>
  <li><a href="#run-names-and-checkpointing" id="toc-run-names-and-checkpointing" class="nav-link" data-scroll-target="#run-names-and-checkpointing">Run Names and Checkpointing</a>
  <ul class="collapse">
  <li><a href="#get_latest_ckpt" id="toc-get_latest_ckpt" class="nav-link" data-scroll-target="#get_latest_ckpt">get_latest_ckpt</a></li>
  <li><a href="#get_run_info" id="toc-get_run_info" class="nav-link" data-scroll-target="#get_run_info">get_run_info</a></li>
  <li><a href="#rnd_string" id="toc-rnd_string" class="nav-link" data-scroll-target="#rnd_string">rnd_string</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/drscotthawley/aeiou/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">core</h1>
</div>

<div>
  <div class="description">
    core routines
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L26" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="get_device" class="level3">
<h3 class="anchored" data-anchor-id="get_device">get_device</h3>
<blockquote class="blockquote">
<pre><code> get_device (gpu_str='')</code></pre>
</blockquote>
<p><em>utility to suggest which pytorch device to use</em></p>
<div id="cell-4" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>get_device()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>device(type='cuda')</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L38" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="is_tool" class="level3">
<h3 class="anchored" data-anchor-id="is_tool">is_tool</h3>
<blockquote class="blockquote">
<pre><code> is_tool (name)</code></pre>
</blockquote>
<p><em>Check whether <code>name</code> is on PATH and marked as executable.</em></p>
<div id="cell-6" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>is_tool(<span class="st">'ffmpeg'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>True</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L47" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="normalize_audio" class="level3">
<h3 class="anchored" data-anchor-id="normalize_audio">normalize_audio</h3>
<blockquote class="blockquote">
<pre><code> normalize_audio (audio_in, norm='global')</code></pre>
</blockquote>
<p><em>normalize audio, based on the max of the absolute value</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>audio_in</td>
<td></td>
<td></td>
<td>input array/tensor (numpy or Pytorch)</td>
</tr>
<tr class="even">
<td>norm</td>
<td>str</td>
<td>global</td>
<td>global (use max-abs of whole clip) | channel (per-channel norm’d individually) | ’’/None</td>
</tr>
</tbody>
</table>
<p>Testing <a href="https://drscotthawley.github.io/aeiou/core.html#normalize_audio"><code>normalize_audio</code></a>:</p>
<div id="cell-9" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.random.rand(<span class="dv">20</span>)<span class="op">-</span><span class="fl">0.5</span>  <span class="co"># mono</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>y2 <span class="op">=</span> normalize_audio(y)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>plot_norm_inout(y, y2) <span class="co"># I wrote a little test function just to plot these for the documentation; not part of aeiou</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-10" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.random.rand(<span class="dv">2</span>,<span class="dv">20</span>)<span class="op">-</span><span class="fl">0.5</span>  <span class="co"># stereo</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">0</span>,:] <span class="op">*=</span> <span class="fl">0.5</span>     <span class="co"># but make one channel smaller for show </span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>y2 <span class="op">=</span> normalize_audio(y)   <span class="co"># global norm, the default</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>plot_norm_inout(y, y2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>See how the orange-squares line above is bigger than the corresponding blue-squares line, but the orange one doesn’t go all the way to +/-1? Contrast that with the following below where we normalize the same input signal per channel:</p>
<div id="cell-12" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>y2 <span class="op">=</span> normalize_audio(y, norm<span class="op">=</span><span class="st">'channel'</span>)   <span class="co"># per-channel norm</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>plot_norm_inout(y, y2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="00_core_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>…. the orange-squares line now extends to the full range.</p>
</section>
<section id="load_audio" class="level2">
<h2 class="anchored" data-anchor-id="load_audio">load_audio</h2>
<p>We’ll start with a basic utilty to read an audio file. If it’s not at the sample rate we want, we’ll automatically resample it. Note that if you want MP3 support, you’ll need to install <code>ffmpeg</code> system-wide first.</p>
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L66" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="load_audio-1" class="level3">
<h3 class="anchored" data-anchor-id="load_audio-1">load_audio</h3>
<blockquote class="blockquote">
<pre><code> load_audio (filename:str, sr=48000, verbose=True, norm='')</code></pre>
</blockquote>
<p><em>loads an audio file as a torch tensor</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>filename</td>
<td>str</td>
<td></td>
<td>name of file to load</td>
</tr>
<tr class="even">
<td>sr</td>
<td>int</td>
<td>48000</td>
<td>sample rate in Hz</td>
</tr>
<tr class="odd">
<td>verbose</td>
<td>bool</td>
<td>True</td>
<td>whether or not to print notices of resampling</td>
</tr>
<tr class="even">
<td>norm</td>
<td>str</td>
<td></td>
<td>passedto normalize_audio(), see above</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>tensor</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Using the file in <code>examples/</code>, let’s see how this works:</p>
<div id="cell-17" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>audio <span class="op">=</span> load_audio(<span class="st">'examples/example.wav'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Resampling examples/example.wav from 44100 Hz to 48000 Hz</code></pre>
</div>
</div>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>audio <span class="op">=</span> load_audio(<span class="st">'examples/example.wav'</span>,verbose<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s check to see if we can read MP3s:</p>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> norm <span class="kw">in</span> [<span class="st">''</span>,<span class="st">'global'</span>,<span class="st">'channel'</span>]:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    audio <span class="op">=</span> load_audio(<span class="st">'examples/stereo_pewpew.mp3'</span>,verbose<span class="op">=</span><span class="va">False</span>, norm<span class="op">=</span>norm)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"norm = </span><span class="sc">{</span>norm<span class="sc">}</span><span class="ss">: shape = "</span>,audio.shape, <span class="st">"Per-channel abs-maxes are : "</span>, np.<span class="bu">abs</span>(audio.numpy()).<span class="bu">max</span>(axis<span class="op">=-</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>norm = : shape =  torch.Size([2, 236983]) Per-channel abs-maxes are :  [0.8505264  0.50114477]
norm = global: shape =  torch.Size([2, 236983]) Per-channel abs-maxes are :  [0.98999995 0.583325  ]
norm = channel: shape =  torch.Size([2, 236983]) Per-channel abs-maxes are :  [0.98999995 0.99      ]</code></pre>
</div>
</div>
<p>Note that <code>pedalboard</code> <em>could</em> be used to read any of the following types of files…</p>
<div id="cell-22" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pdlbd_exts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['.aif', '.aiff', '.bwf', '.flac', '.mp3', '.ogg', '.wav']</code></pre>
</div>
</div>
<p>…but we’re only using it for MP3s right now, and <code>torchaudio</code> for everything else.</p>
</section>
</section>
<section id="get_dbmax" class="level2">
<h2 class="anchored" data-anchor-id="get_dbmax">get_dbmax</h2>
<p>Finds loudest sample value in the entire clip and returns the value as decibels</p>
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L95" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="get_dbmax-1" class="level3">
<h3 class="anchored" data-anchor-id="get_dbmax-1">get_dbmax</h3>
<blockquote class="blockquote">
<pre><code> get_dbmax (audio)</code></pre>
</blockquote>
<p><em>finds the loudest value in the entire clip and puts that into dB (full scale)</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>audio</td>
<td>torch tensor of (multichannel) audio</td>
</tr>
</tbody>
</table>
<div id="cell-26" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"dbmax of last-loaded audio is"</span>,get_dbmax(audio))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dbmax of last-loaded audio is -0.08729602210223675</code></pre>
</div>
</div>
</section>
</section>
<section id="is_silence" class="level2">
<h2 class="anchored" data-anchor-id="is_silence">is_silence</h2>
<p>Sometimes we’ll want to know if a file is “silent”, i.e.&nbsp;if its contents are quieter than some threshold. Here’s one simple way to implement that:</p>
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L102" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="audio_float_to_int" class="level3">
<h3 class="anchored" data-anchor-id="audio_float_to_int">audio_float_to_int</h3>
<blockquote class="blockquote">
<pre><code> audio_float_to_int (waveform)</code></pre>
</blockquote>
<p><em>converts torch float to numpy int16 (for playback in notebooks)</em></p>
<div id="cell-29" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(audio.dtype)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(audio_float_to_int(audio).dtype)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch.float32
int16</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L107" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="is_silence-1" class="level3">
<h3 class="anchored" data-anchor-id="is_silence-1">is_silence</h3>
<blockquote class="blockquote">
<pre><code> is_silence (audio, thresh=-60)</code></pre>
</blockquote>
<p><em>checks if entire clip is ‘silence’ below some dB threshold</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>audio</td>
<td></td>
<td></td>
<td>torch tensor of (multichannel) audio</td>
</tr>
<tr class="even">
<td>thresh</td>
<td>int</td>
<td>-60</td>
<td>threshold in dB below which we declare to be silence</td>
</tr>
</tbody>
</table>
<p>Let’s test that with some tests. If all goes well, the following <code>assert</code> statements will all pass uneventfully.</p>
<div id="cell-32" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> torch.ones((<span class="dv">2</span>,<span class="dv">10</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> is_silence(<span class="fl">1e-3</span><span class="op">*</span>x) <span class="co"># not silent</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> is_silence(<span class="fl">1e-5</span><span class="op">*</span>x) <span class="co"># silent</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> is_silence(<span class="fl">1e-3</span><span class="op">*</span>x, thresh<span class="op">=-</span><span class="dv">50</span>) <span class="co"># higher thresh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="batch_it_crazy" class="level2">
<h2 class="anchored" data-anchor-id="batch_it_crazy">batch_it_crazy</h2>
<p>This is a pretty basic utility for breaking up a long sequence into batches, e.g.&nbsp;for model inference</p>
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L116" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="batch_it_crazy-1" class="level3">
<h3 class="anchored" data-anchor-id="batch_it_crazy-1">batch_it_crazy</h3>
<blockquote class="blockquote">
<pre><code> batch_it_crazy (x, win_len)</code></pre>
</blockquote>
<p><em>(pun intended) Chop up long sequence into a batch of win_len windows</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 84%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x</td>
<td>a time series as a PyTorch tensor, e.g.&nbsp;stereo or mono audio</td>
</tr>
<tr class="even">
<td>win_len</td>
<td>length of each “window”, i.e.&nbsp;length of each element in new batch</td>
</tr>
</tbody>
</table>
<p>Testing <code>batch_it_crazy()</code> for stereo input:</p>
<div id="cell-36" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> torch.ones([<span class="dv">2</span>,<span class="dv">1000</span>])  <span class="co"># stereo</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>batch_it_crazy(x, <span class="dv">10</span>).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([101, 2, 10])</code></pre>
</div>
</div>
<p>…and for mono:</p>
<div id="cell-38" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> torch.ones([<span class="dv">1000</span>])   <span class="co"># mono</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>batch_it_crazy(x, <span class="dv">10</span>).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([101, 1, 10])</code></pre>
</div>
</div>
<p>…and yeah, currently that “<code>1,</code>” stays because other parts of the code(s) will be assuming “multichannel” audio.</p>
</section>
</section>
<section id="makedir" class="level2">
<h2 class="anchored" data-anchor-id="makedir">makedir</h2>
<p>The next routine creates a directory if it doesn’t already exist. We’ll even let it take a “nested” directory such as <code>a/b/c/d</code> and the routine will create any directories in that string.</p>
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L129" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="makedir-1" class="level3">
<h3 class="anchored" data-anchor-id="makedir-1">makedir</h3>
<blockquote class="blockquote">
<pre><code> makedir (path:str)</code></pre>
</blockquote>
<p><em>creates directories where they don’t exist</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>path</td>
<td>str</td>
<td>directory or nested set of directories</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="get_audio_filenames" class="level2">
<h2 class="anchored" data-anchor-id="get_audio_filenames">get_audio_filenames</h2>
<p>Often we’ll want to grab a long list of audio filenames by looking through a directory and all its subdirectories. We could use something like <code>glob</code>, <code>glob</code> turns out to be extremely slow when large numbers of files (say, more than 100,000) are involved. Instead we will use the much faster <code>os.scandir()</code>, which was packaged nicely into the following routine in <a href="https://stackoverflow.com/a/59803793/4259243">an answer to a StackOverflow question</a> from which this code is modified:</p>
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L141" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="fast_scandir" class="level3">
<h3 class="anchored" data-anchor-id="fast_scandir">fast_scandir</h3>
<blockquote class="blockquote">
<pre><code> fast_scandir (dir:str, ext:list)</code></pre>
</blockquote>
<p><em>very fast <code>glob</code> alternative. from https://stackoverflow.com/a/59803793/4259243</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>dir</td>
<td>str</td>
<td>top-level directory at which to begin scanning</td>
</tr>
<tr class="even">
<td>ext</td>
<td>list</td>
<td>list of allowed file extensions</td>
</tr>
</tbody>
</table>
<p>Quick test:</p>
<div id="cell-45" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>_, files <span class="op">=</span> fast_scandir(<span class="st">'examples/'</span>, [<span class="st">'wav'</span>,<span class="st">'flac'</span>,<span class="st">'ogg'</span>,<span class="st">'aiff'</span>,<span class="st">'aif'</span>,<span class="st">'mp3'</span>])</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['examples/stereo_pewpew.mp3', 'examples/example.wav']</code></pre>
</div>
</div>
<p>Often, rather than being given a single parent directory, we may be given a list of directories in which to look for files. The following just called <code>fast_scandir()</code> for each of those:</p>
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L168" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_audio_filenames-1" class="level3">
<h3 class="anchored" data-anchor-id="get_audio_filenames-1">get_audio_filenames</h3>
<blockquote class="blockquote">
<pre><code> get_audio_filenames (paths:list)</code></pre>
</blockquote>
<p><em>recursively get a list of audio filenames</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>paths</td>
<td>list</td>
<td>directories in which to search</td>
</tr>
</tbody>
</table>
<p>Here’s a fun trick to show off how fast this is: Run in the user’s directory tree:</p>
<div id="cell-49" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="bu">str</span>(os.path.expanduser(<span class="st">"~"</span>))<span class="op">+</span><span class="st">'/Downloads'</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(path):</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> get_audio_filenames(path)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Found </span><span class="sc">{</span><span class="bu">len</span>(files)<span class="sc">}</span><span class="ss"> audio files."</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Ok it was just a thought."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ok it was just a thought.</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L180" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="untuple" class="level3">
<h3 class="anchored" data-anchor-id="untuple">untuple</h3>
<blockquote class="blockquote">
<pre><code> untuple (x, verbose=False)</code></pre>
</blockquote>
<p><em>Recursive. For when you’re sick of tuples and lists: keeps peeling off elements until we get a non-tuple or non-list, i.e., returns the ‘first’ data element we can ‘actually use’</em></p>
<div id="cell-51" class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> [[((<span class="dv">5</span>,<span class="dv">6</span>),<span class="dv">7</span>)]]</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(a)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(untuple(a, verbose<span class="op">=</span><span class="va">True</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[((5, 6), 7)]]
yea: x =  [[((5, 6), 7)]]
yea: x =  [((5, 6), 7)]
yea: x =  ((5, 6), 7)
yea: x =  (5, 6)
no: x =  5
5</code></pre>
</div>
</div>
</section>
</section>
<section id="run-names-and-checkpointing" class="level2">
<h2 class="anchored" data-anchor-id="run-names-and-checkpointing">Run Names and Checkpointing</h2>
<p>in concert with Pytorch Lightning</p>
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L192" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="get_latest_ckpt" class="level3">
<h3 class="anchored" data-anchor-id="get_latest_ckpt">get_latest_ckpt</h3>
<blockquote class="blockquote">
<pre><code> get_latest_ckpt (dir_tree, run_name_prefix='', sim_ckpts=[''],
                  verbose=True)</code></pre>
</blockquote>
<p><em>This will grab the most recent checkpoint filename in dir tree given by name</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>dir_tree</td>
<td></td>
<td></td>
<td>name of the run without unique identifer</td>
</tr>
<tr class="even">
<td>run_name_prefix</td>
<td>str</td>
<td></td>
<td>unique identifier for particular run</td>
</tr>
<tr class="odd">
<td>sim_ckpts</td>
<td>list</td>
<td>[’’]</td>
<td>string or list of strings. other paths to check under if nothing’s in dir_tree</td>
</tr>
<tr class="even">
<td>verbose</td>
<td>bool</td>
<td>True</td>
<td>whether to print message(s)</td>
</tr>
</tbody>
</table>
<div id="cell-54" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># testing</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>get_latest_ckpt(<span class="st">'/fsx/shawley/runs/clapg88s'</span>, </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>                run_name_prefix<span class="op">=</span><span class="st">'songlike'</span>, </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>                sim_ckpts<span class="op">=</span><span class="st">'/fsx/shawley/runs/longer-songs2-stacked-clap-audio'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Nothing relevant found in /fsx/shawley/runs/clapg88s. Checking also in /fsx/shawley/runs/longer-songs2-stacked-clap-audio.
   pattern =  /fsx/shawley/runs/longer-songs2-stacked-clap-audio
   Also checking in  ['/fsx/shawley/runs/longer-songs2-stacked-clap-audio']
     directory =  /fsx/shawley/runs/longer-songs2-stacked-clap-audio</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Path('/fsx/shawley/runs/longer-songs2-stacked-clap-audio/songlike_0eac0fa8/checkpoints/epoch=10-step=100000.ckpt')</code></pre>
</div>
</div>
<div id="cell-55" class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">#testing</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">'/fsx/shawley/runs/longer-songs2-stacked-clap-audio'</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>ckpt_path <span class="op">=</span> get_latest_ckpt(name, run_name_prefix<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>ckpt_path</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Looking for latest checkpoint in /fsx/shawley/runs/longer-songs2-stacked-clap-audio/*/checkpoints/*.ckpt</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>'/fsx/shawley/runs/longer-songs2-stacked-clap-audio/songlike_0eac0fa8/checkpoints/epoch=10-step=100000.ckpt'</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L220" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_run_info" class="level3">
<h3 class="anchored" data-anchor-id="get_run_info">get_run_info</h3>
<blockquote class="blockquote">
<pre><code> get_run_info (run_name, verbose=True)</code></pre>
</blockquote>
<p><em>parses run_name into (ideally) prefix &amp; id using underscore as separator, and/or fills in missing info if needed NOTE: do not trust generated strings to be same on other processes</em></p>
<hr>
<p><a href="https://github.com/drscotthawley/aeiou/blob/main/aeiou/core.py#L215" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="rnd_string" class="level3">
<h3 class="anchored" data-anchor-id="rnd_string">rnd_string</h3>
<blockquote class="blockquote">
<pre><code> rnd_string (n=8)</code></pre>
</blockquote>
<p><em>random letters and numbers of given length. case sensitive</em></p>
<div id="cell-58" class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>get_run_info(<span class="st">'songlike_345876jh'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'prefix': 'songlike', 'id': '345876jh', 'run_name': 'songlike_345876jh'}</code></pre>
</div>
</div>
<p>Sample usage of the previous few functions:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reading from OLD checkpoint to start</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    run_info <span class="op">=</span> get_run_info(args.run_name)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    grab_latest_checkpoint <span class="op">=</span> <span class="va">True</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> grab_latest_checkpoint:</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Looking for old checkpoint to load for startup"</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>        ckpt_path <span class="op">=</span> get_latest_ckpt(args.name, run_name_prefix<span class="op">=</span>run_info[<span class="st">'prefix'</span>]) </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> os.path.exists(ckpt_path):</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Found latest checkpoint at </span><span class="sc">{</span>ckpt_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>            args.ckpt_path <span class="op">=</span> ckpt_path</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.ckpt_path:</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Loading model from </span><span class="sc">{</span>args<span class="sc">.</span>ckpt_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> OurModel.load_from_checkpoint(args.ckpt_path, latent_ae<span class="op">=</span>latent_diffae, clap_module<span class="op">=</span>clap_module, strict<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> OurModel(latent_ae<span class="op">=</span>latent_diffae, clap_module<span class="op">=</span>clap_module)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Where to save NEW checkpoints</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    ckpt_dir <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>args<span class="sc">.</span>name<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>run_info[<span class="st">'run_name'</span>]<span class="sc">}</span><span class="ss">/checkpoints"</span> </span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"New checkpoints will be saved in </span><span class="sc">{</span>ckpt_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>    ckpt_callback <span class="op">=</span> pl.callbacks.ModelCheckpoint(dirpath<span class="op">=</span>ckpt_dir, every_n_train_steps<span class="op">=</span>args.checkpoint_every, save_top_k<span class="op">=-</span><span class="dv">1</span>, save_last<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>    wandb_logger <span class="op">=</span> pl.loggers.WandbLogger(project<span class="op">=</span>args.name, <span class="bu">id</span><span class="op">=</span>run_info[<span class="st">'id'</span>]) </span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>    wandb_logger.watch(latent_diffusion_model)</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>    push_wandb_config(wandb_logger, args)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/drscotthawley\.github\.io\/aeiou\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/drscotthawley/aeiou/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>